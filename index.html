
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Scratch Adventure üíï</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); height:100vh; overflow:hidden; color:#fff; touch-action:none; }

    /* ===== FLOATING PARTICLES - MULTI COLOR ===== */
    .particles { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
    .particle { position:absolute; border-radius:50%; animation:float 8s infinite ease-in-out; }
    .particle.heart { width:12px; height:12px; background:#ff6b6b; }
    .particle.dot1 { width:8px; height:8px; background:#ffd93d; }
    .particle.dot2 { width:10px; height:10px; background:#4CAF50; }
    .particle.dot3 { width:6px; height:6px; background:#2196F3; }
    .particle.dot4 { width:9px; height:9px; background:#9C27B0; }
    @keyframes float { 0%,100%{transform:translateY(100vh) translateX(0);opacity:0} 10%,90%{opacity:0.7} 50%{transform:translateY(-20px) translateX(20px)} }

    /* ===== POPUPS ===== */
    .popup-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:1000; }
    .popup { background:white; padding:30px; border-radius:20px; text-align:center; max-width:90%; }
    .popup h3 { margin-bottom:15px; color:#333; font-size:1.5em; }
    .popup input { padding:12px; border:2px solid #ff6b6b; border-radius:25px; width:100%; margin:15px 0; font-size:1em; }
    .popup button { padding:12px 30px; margin:5px; border:none; border-radius:20px; cursor:pointer; font-weight:bold; font-size:1em; }

    /* ===== WELCOME SCREEN ===== */
    .welcome-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; position:relative; z-index:1; }
    .main-title { font-size:4em; margin-bottom:30px; background:linear-gradient(45deg, #ff6b6b, #ffd93d); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .create-btn { padding:18px 50px; font-size:1.2em; background:linear-gradient(45deg, #ff6b6b, #ff8787); border:none; border-radius:50px; color:white; cursor:pointer; font-weight:bold; }

    /* ===== GAME SCREEN ===== */
    .game-screen { display:none; flex-direction:column; height:100vh; position:relative; z-index:1; }
    .game-screen.visible { display:flex; }

    /* ===== TOP BAR ===== */
    .top-bar { display:flex; justify-content:space-between; padding:15px; position:fixed; top:0; left:0; right:0; background:rgba(0,0,0,0.1); backdrop-filter:blur(10px); z-index:100; }
    .top-btn { width:45px; height:45px; border:none; border-radius:50%; background:rgba(255,255,255,0.2); color:white; cursor:pointer; }

    /* ===== CENTER CONTENT ===== */
    .center-content { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:80px 20px; }
    .game-title { font-size:2.5em; color:#000; margin-bottom:10px; }
    .instruction { font-size:1.2em; color:#333; margin-bottom:10px; }
    .turn-indicator { margin:10px 0; font-size:1.3em; font-weight:bold; color:#333; }
    .name-plate { background:linear-gradient(45deg, gold, #ffd700); padding:10px 25px; border-radius:25px; color:#333; font-weight:bold; margin:10px 0; }

    /* ===== DARE BOX - RED ===== */
    .dare-box { position:relative; width:350px; height:120px; margin:20px 0; }
    #scratchCanvas { position:absolute; top:0; left:0; width:100%; height:100%; background:#ff0000; cursor:crosshair; border-radius:15px; }
    #dareText { position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; text-align:center; background:white; border-radius:15px; color:#333; font-weight:bold; padding:15px; }

    /* ===== BUTTON ===== */
    .complete-btn { padding:15px 40px; background:linear-gradient(45deg, #4CAF50, #66BB6A); border:none; border-radius:30px; color:white; cursor:pointer; font-weight:bold; margin:20px 0; }
    .hidden { display:none !important; }

    /* ===== BOTTOM BAR ===== */
    .bottom-bar { display:flex; justify-content:space-between; align-items:center; padding:15px; position:fixed; bottom:0; left:0; right:0; background:rgba(0,0,0,0.1); backdrop-filter:blur(10px); }
    .profile-status { display:flex; align-items:center; gap:10px; }
    .profile-icon { width:35px; height:35px; border-radius:50%; background:#ff6b6b; display:flex; align-items:center; justify-content:center; }
    .creator-info { color:#333; font-size:0.9em; }
    
    /* ===== STATUS DOT ===== */
    .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-left:5px; }
    .status-online { background:#4CAF50; animation:blink 1.5s infinite; }
    .status-offline { background:#ccc; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.5} }
  </style>
</head>
<body>
  <div class="particles"></div>

  <!-- POPUPS -->
  <div class="popup-overlay" id="exitConfirm"><div class="popup"><h3>‚ùå Exit Game?</h3><button onclick="exitGame()">Confirm</button><button onclick="closePopup('exitConfirm')">Cancel</button></div></div>
  <div class="popup-overlay" id="roomPopup"><div class="popup"><h3>üéÆ Create Room</h3><input type="text" id="roomNameInput" placeholder="Enter your name..." maxlength="20"><button onclick="createRoom()">Create Room</button><button onclick="closePopup('roomPopup')">Cancel</button></div></div>
  <div class="popup-overlay" id="invitePopup"><div class="popup"><h3>üîó Invite Friend</h3><input type="text" id="inviteLink" readonly><button onclick="copyLink()">Copy Link</button><button onclick="closePopup('invitePopup')">Close</button></div></div>

  <!-- WELCOME -->
  <div class="welcome-screen" id="welcomeScreen">
    <h1 class="main-title">üíï Scratch Adventure üíï</h1>
    <button class="create-btn" onclick="openPopup('roomPopup')">Create Room</button>
  </div>

  <!-- GAME -->
  <div class="game-screen" id="gameScreen">
    <div class="top-bar">
      <button class="top-btn" onclick="openPopup('exitConfirm')">‚ùå</button>
      <button class="top-btn" id="inviteBtn" onclick="openPopup('invitePopup')">üîó</button>
    </div>

    <div class="center-content">
      <h2 class="game-title">üíï Scratch Adventure</h2>
      <p class="instruction">Scratch the field with your finger</p>
      <div class="turn-indicator" id="turnIndicator">Waiting for partner to join...</div>
      <div class="name-plate" id="creatorName">Room</div>
      
      <div class="dare-box">
        <canvas id="scratchCanvas"></canvas>
        <div id="dareText">‚ô•Ô∏è Scratch to reveal!</div>
      </div>
      
      <button class="complete-btn hidden" id="completeBtn" onclick="completeDare()">‚úÖ Dare Completed</button>
    </div>

    <div class="bottom-bar">
      <div class="profile-status"><div class="profile-icon">üë§</div><span id="joinerStatus">Partner <span class="status-dot status-offline" id="statusDot"></span></span></div>
      <div class="creator-info">Created by urluv_harrryyy</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const CONFIG = { SCRATCH_THRESHOLD: 0.6, CANVAS_WIDTH: 350, CANVAS_HEIGHT: 120, SCRATCH_RADIUS: 25, PIXEL_SAMPLE_RATE: 40 };
    const socket = io();
    let currentRole = '', currentRoom = '', creatorName = '', hasScratched = false, isMyTurn = false, joinerJoined = false;

    // CREATE PARTICLES
    const container = document.querySelector('.particles');
    const types = ['heart', 'dot1', 'dot2', 'dot3', 'dot4'];
    for(let i=0; i<20; i++) {
      const p = document.createElement('div');
      p.className = 'particle ' + types[Math.floor(Math.random()*types.length)];
      p.style.left = Math.random()*100 + '%';
      p.style.top = '100vh';
      p.style.animationDelay = Math.random()*8 + 's';
      container.appendChild(p);
    }

    // POPUP
    function openPopup(id) { document.getElementById(id).style.display = 'flex'; }
    function closePopup(id) { document.getElementById(id).style.display = 'none'; }
    function copyLink() {
      const link = document.getElementById('inviteLink');
      navigator.clipboard.writeText(link.value).then(() => {
        alert('üìã Link copied! Share it with your partner!');
        closePopup('invitePopup');
      });
    }

    // ROOM
    function createRoom() {
      const name = document.getElementById('roomNameInput').value.trim().replace(/[<>\"']/g, '').substring(0, 20);
      if(!name) return alert('Please enter your name!');
      currentRoom = name;
      creatorName = name;
      currentRole = 'creator';
      document.getElementById('creatorName').textContent = name;
      document.getElementById('inviteBtn').style.display = 'block';
      joinGame();
      closePopup('roomPopup');
    }

    function joinGame() {
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameScreen').classList.add('visible');
      setupCanvas();
      socket.emit('join', currentRoom);
      
      // ACTIVE STATUS HEARTBEAT
      setInterval(() => {
        if(currentRoom && socket.connected) {
          socket.emit('user-active', { room: currentRoom, active: !document.hidden });
        }
      }, 3000);
    }

    // CANVAS
    const canvas = document.getElementById('scratchCanvas');
    const ctx = canvas.getContext('2d');
    function setupCanvas() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = CONFIG.CANVAS_WIDTH * dpr;
      canvas.height = CONFIG.CANVAS_HEIGHT * dpr;
      canvas.style.width = CONFIG.CANVAS_WIDTH + 'px';
      canvas.style.height = CONFIG.CANVAS_HEIGHT + 'px';
      ctx.scale(dpr, dpr);
      
      // RED LAYER
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = '#ff0000';
      ctx.fillRect(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
      
      // ERASE MODE
      ctx.globalCompositeOperation = 'destination-out';
    }

    // SOCKET
    socket.on('role', (role) => {
      currentRole = role;
      isMyTurn = (role === 'creator');
      if(role === 'joiner') document.getElementById('inviteBtn').style.display = 'none';
      updateUI();
    });

    socket.on('state', (state) => {
      joinerJoined = state.joinerJoined;
      hasScratched = state.scratched;
      document.getElementById('dareText').textContent = state.scratched ? state.dare : '‚ô•Ô∏è Scratch to reveal!';
      updateUI();
      if(!state.scratched) setupCanvas();
    });

    socket.on('joiner-joined', () => {
      joinerJoined = true;
      updateUI();
    });

    socket.on('joiner-left', () => {
      joinerJoined = false;
      updateUI();
    });

    socket.on('user-active-status', (data) => {
      const dot = document.getElementById('statusDot');
      dot.className = data.active ? 'status-dot status-online' : 'status-dot status-offline';
    });

    socket.on('new-turn', (data) => {
      hasScratched = false;
      document.getElementById('dareText').textContent = '‚ô•Ô∏è Scratch to reveal!';
      document.getElementById('completeBtn').classList.add('hidden');
      setupCanvas();
      isMyTurn = (currentRole === data.turn);
      updateUI();
    });

    socket.on('reveal', (dare) => {
      document.getElementById('dareText').textContent = dare;
      document.getElementById('completeBtn').classList.remove('hidden');
      hasScratched = true;
      updateUI();
    });

    socket.on('room-closed', () => {
      alert('üö´ Room closed by creator. Redirecting...');
      window.location.href = window.location.pathname;
    });

    // UI UPDATE
    function updateUI() {
      const indicator = document.getElementById('turnIndicator');
      const dot = document.getElementById('statusDot');
      const btn = document.getElementById('completeBtn');
      
      dot.className = joinerJoined ? 'status-dot status-online' : 'status-dot status-offline';
      
      if(!joinerJoined) indicator.textContent = '‚è≥ Waiting for partner to join...';
      else if(isMyTurn && !hasScratched) indicator.textContent = '‚ú® Your turn! Scratch to reveal';
      else if(!isMyTurn && !hasScratched) indicator.textContent = '‚è≥ Waiting for partner to scratch...';
      else if(hasScratched) indicator.textContent = 'üíñ Dare revealed! Tap "Dare Completed"';
      
      if(hasScratched && joinerJoined) btn.classList.remove('hidden');
      else btn.classList.add('hidden');
    }

    // DARE COMPLETION
    function completeDare() {
      if(!hasScratched || !joinerJoined) return;
      socket.emit('done', currentRoom);
      document.getElementById('completeBtn').classList.add('hidden');
      hasScratched = false;
      updateUI();
    }

    // SCRATCHING
    let isDrawing = false, lastX = 0, lastY = 0;

    canvas.onmousedown = (e) => {
      if(!isMyTurn || !joinerJoined || hasScratched) return;
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = (e.clientX - rect.left) * (CONFIG.CANVAS_WIDTH / rect.width);
      lastY = (e.clientY - rect.top) * (CONFIG.CANVAS_HEIGHT / rect.height);
    };

    canvas.onmousemove = (e) => {
      if(!isDrawing || !isMyTurn || !joinerJoined || hasScratched) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (CONFIG.CANVAS_WIDTH / rect.width);
      const y = (e.clientY - rect.top) * (CONFIG.CANVAS_HEIGHT / rect.height);
      
      ctx.lineWidth = CONFIG.SCRATCH_RADIUS * 2;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      
      lastX = x; lastY = y;
      socket.emit('scratch', { room: currentRoom, x, y, radius: CONFIG.SCRATCH_RADIUS });
    };

    canvas.onmouseup = () => {
      if(isMyTurn) {
        isDrawing = false;
        checkScratchComplete();
      }
    };

    canvas.ontouchstart = (e) => {
      e.preventDefault();
      if(!isMyTurn || !joinerJoined || hasScratched) return;
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = (e.touches[0].clientX - rect.left) * (CONFIG.CANVAS_WIDTH / rect.width);
      lastY = (e.touches[0].clientY - rect.top) * (CONFIG.CANVAS_HEIGHT / rect.height);
    };

    canvas.ontouchmove = (e) => {
      e.preventDefault();
      if(!isDrawing || !isMyTurn || !joinerJoined || hasScratched) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.touches[0].clientX - rect.left) * (CONFIG.CANVAS_WIDTH / rect.width);
      const y = (e.touches[0].clientY - rect.top) * (CONFIG.CANVAS_HEIGHT / rect.height);
      
      ctx.lineWidth = CONFIG.SCRATCH_RADIUS * 2;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      
      lastX = x; lastY = y;
      socket.emit('scratch', { room: currentRoom, x, y, radius: CONFIG.SCRATCH_RADIUS });
    };

    canvas.ontouchend = () => {
      if(isMyTurn) {
        isDrawing = false;
        checkScratchComplete();
      }
    };

    socket.on('scratch', (data) => {
      ctx.beginPath();
      ctx.arc(data.x, data.y, data.radius, 0, Math.PI * 2);
      ctx.fill();
    });

    function checkScratchComplete() {
      try {
        const img = ctx.getImageData(0, 0, CONFIG.CANVAS_WIDTH, CONFIG.CANVAS_HEIGHT);
        let transparent = 0;
        for(let i=3; i<img.data.length; i+=CONFIG.PIXEL_SAMPLE_RATE) {
          if(img.data[i] < 128) transparent++;
        }
        if(transparent > (img.data.length / CONFIG.PIXEL_SAMPLE_RATE) * CONFIG.SCRATCH_THRESHOLD && isMyTurn) {
          socket.emit('scratch-complete', currentRoom);
        }
      } catch(e) {
        console.error(e);
      }
    }

    // EXIT
    function exitGame() {
      if(confirm('Exit game? Room will be closed!')) {
        socket.disconnect();
        location.href = location.pathname;
      }
    }

    // JOIN FROM URL
    const params = new URLSearchParams(location.search);
    const r = params.get('room');
    if(r) {
      currentRoom = r;
      creatorName = r;
      currentRole = 'joiner';
      document.getElementById('creatorName').textContent = r;
      document.getElementById('inviteBtn').style.display = 'none';
      socket.emit('join', r);
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('gameScreen').classList.add('visible');
      setupCanvas();
    }
  </script>
</body>
</html>
