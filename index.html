<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Scratch Adventure üíï</title>

<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{
  font-family:Segoe UI,Tahoma,Verdana,sans-serif;
  background:linear-gradient(135deg,#ff9a9e,#fad0c4);
  color:#333;
  position:fixed;width:100%;height:100%;
  -webkit-font-smoothing:antialiased;
  -webkit-overflow-scrolling:touch
}

/* ===== ANIMATED BACKGROUND ===== */
.particles{position:fixed;inset:0;pointer-events:none;z-index:0}
.particle{
  position:absolute;border-radius:50%;opacity:.6;
  animation:float 8s infinite ease-in-out
}
.heart{width:14px;height:14px;background:#ff5e78}
.dot{width:10px;height:10px;background:#fff}
@keyframes float{
  0%{transform:translateY(0)}
  50%{transform:translateY(-20px)}
  100%{transform:translateY(0)}
}

/* ===== COMMON ===== */
.hidden{display:none!important}
button{cursor:pointer;border:none;outline:none;touch-action:manipulation}

/* ===== WELCOME ===== */
#welcome{
  position:relative;z-index:1;
  height:100vh;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:20px;text-align:center;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
#welcome img{width:200px;animation:pulse 2.5s infinite}
@keyframes pulse{50%{transform:scale(1.05)}}
#welcome h1{
  font-size:3em;
  background:linear-gradient(45deg,#ff416c,#ff4b2b);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent
}
.main-btn{
  padding:15px 45px;
  border-radius:40px;
  background:#ff416c;
  color:#fff;font-size:1.1em;font-weight:bold;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  transition:transform .2s
}
.main-btn:active{transform:scale(.95)}

/* ===== POPUP ===== */
.popup-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  display:flex;align-items:center;justify-content:center;
  z-index:10;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
.popup{
  background:#fff;
  padding:25px;
  border-radius:18px;
  width:90%;max-width:340px;
  text-align:center;
  position:relative;
  max-height:90vh;
  overflow-y:auto;
  animation:slideUp .3s ease-out
}
@keyframes slideUp{from{transform:translateY(50px);opacity:0}}
.popup input{
  width:100%;padding:12px;margin:10px 0;
  border-radius:25px;border:2px solid #ff416c;
  font-size:1em
}
.popup button{
  margin-top:10px;
  padding:12px 30px;
  border-radius:25px;
  background:#ff416c;color:#fff;font-weight:bold;
  transition:transform .2s
}
.popup button:active{transform:scale(.95)}
.error-msg{
  color:#ff416c;font-size:.9em;margin-top:5px;
  display:none;font-weight:bold
}
.success-msg{
  color:#4CAF50;font-size:.9em;margin-top:5px;
  display:none;font-weight:bold
}

/* ===== SHARE MODAL ===== */
.share-modal .popup{
  max-width:380px;
  padding:20px
}
.share-modal h3{
  margin-bottom:15px;color:#ff416c
}
.share-link-box{
  background:#f5f5f5;
  padding:12px;
  border-radius:10px;
  margin:15px 0;
  word-break:break-all;
  font-size:.9em;
  position:relative
}
.copy-btn, .cancel-btn{
  margin:5px;
  padding:10px 25px;
  border-radius:20px;
  font-size:.95em;
  transition:transform .2s
}
.copy-btn{background:#4CAF50}
.cancel-btn{background:#999}
.copy-btn:active, .cancel-btn:active{transform:scale(.95)}
.share-apps{
  display:flex;
  justify-content:space-around;
  margin-top:20px;
  padding-top:15px;
  border-top:1px solid #eee
}
.app-icon{
  display:flex;flex-direction:column;
  align-items:center;cursor:pointer;
  transition:transform .2s
}
.app-icon:active{transform:scale(.85)}
.app-icon img{
  width:50px;height:50px;
  border-radius:12px;
  margin-bottom:5px;
  pointer-events:none
}
.app-icon span{font-size:.85em;font-weight:bold}

/* ===== CONFIRM MODAL ===== */
.confirm-modal .popup{
  max-width:320px
}
.confirm-modal p{
  margin:20px 0;
  font-size:1.1em;
  color:#333
}
.confirm-btn{background:#ff416c}
.cancel-btn{background:#999}

/* ===== GAME ===== */
#game{
  position:relative;z-index:1;
  height:100vh;display:flex;flex-direction:column;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

/* TOP BAR */
.topbar{
  height:60px;
  display:flex;align-items:center;
  justify-content:space-between;
  padding:0 15px;
  background:rgba(255,255,255,.25);
  backdrop-filter:blur(10px)
}
.topbar .center{
  display:flex;align-items:center;gap:6px;
  font-weight:bold
}

/* ===== ACTIVE DOT STYLES ===== */
.dot-online{
  width:10px;
  height:10px;
  border-radius:50%;
  background:#4CAF50;
  animation:pulseDot 2s infinite;
  box-shadow:0 0 0 0 rgba(76,175,80,.7)
}
.dot-offline{
  width:10px;
  height:10px;
  border-radius:50%;
  background:#ccc
}
@keyframes pulseDot{
  0%{
    box-shadow:0 0 0 0 rgba(76,175,80,.7);
    transform:scale(1)
  }
  70%{
    box-shadow:0 0 0 10px rgba(76,175,80,0);
    transform:scale(1.1)
  }
  100%{
    box-shadow:0 0 0 0 rgba(76,175,80,0);
    transform:scale(1)
  }
}

/* BODY */
.body{
  flex:1;
  display:flex;flex-direction:column;
  align-items:center;
  padding:15px;
  text-align:center;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch
}
.body img{width:160px;margin:10px 0}
.body h2{font-size:2.2em;color:#ff416c}
.body p{margin:6px 0;font-size:1em}

/* NAME PLATE */
.nameplate{
  background:linear-gradient(45deg,gold,#ffd700);
  padding:8px 22px;border-radius:20px;
  font-weight:bold;margin:10px 0;
  box-shadow:0 2px 10px rgba(0,0,0,.1)
}

/* DARE BOX */
.dare-box{
  width:340px;max-width:90%;
  height:120px;
  border-radius:15px;
  overflow:hidden;
  position:relative;
  margin:15px 0;
  background:#fff;
  box-shadow:0 6px 20px rgba(0,0,0,.25);
  touch-action:none
}
#dareText{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  padding:12px;
  font-weight:bold;
  text-align:center;
  line-height:1.4;
  word-wrap:break-word;
  font-size:1.1em
}
canvas{
  position:absolute;inset:0;
  z-index:2;width:100%;height:100%
}

/* COMPLETE */
#doneBtn{
  padding:14px 40px;
  border-radius:30px;
  background:#4CAF50;color:#fff;
  font-weight:bold;
  margin-top:10px;
  transition:transform .2s,background .2s
}
#doneBtn:active{transform:scale(.95)}
.creator-tag{
  margin-top:8px;
  font-size:.9em;
  color:rgba(0,0,0,.6)
}

/* ===== RESPONSIVE ===== */
@media (max-width:480px){
  #welcome h1{font-size:2.5em}
  .body h2{font-size:1.8em}
  .dare-box{height:100px}
}
</style>
</head>

<body>

<div class="particles" id="particles"></div>

<!-- WELCOME -->
<div id="welcome">
  <img src="teddy.png" alt="Teddy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß∏</text></svg>'">
  <h1>Scratch Adventure</h1>
  <button class="main-btn" onclick="openCreate()">Create Room</button>
  <button class="main-btn" onclick="openJoin()">Join Room</button>
</div>

<!-- POPUPS -->
<div class="popup-bg hidden" id="createPop">
  <div class="popup">
    <h3>Create Room</h3>
    <input id="cName" placeholder="Room Name (min 3 chars)">
    <input id="cPass" placeholder="Password">
    <div class="error-msg" id="createError"></div>
    <button onclick="createRoom()">Create</button>
  </div>
</div>

<div class="popup-bg hidden" id="joinPop">
  <div class="popup">
    <h3>Join Room</h3>
    <input id="jName" placeholder="Room Name">
    <input id="jPass" placeholder="Password">
    <div class="error-msg" id="joinError"></div>
    <button onclick="joinRoom()">Join</button>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="popup-bg hidden share-modal" id="sharePop">
  <div class="popup">
    <h3>Share Room Link</h3>
    <div class="share-link-box" id="shareLink"></div>
    <div class="success-msg" id="copySuccess">‚úì Link copied!</div>
    <button class="copy-btn" onclick="copyLink()">Copy Link</button>
    <button class="cancel-btn" onclick="closeShare()">Cancel</button>
    <div class="share-apps">
      <div class="app-icon" onclick="shareToApp('whatsapp')">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/whatsapp/whatsapp-original.svg" alt="WhatsApp" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíö</text></svg>'">
        <span>WhatsApp</span>
      </div>
      <div class="app-icon" onclick="shareToApp('instagram')">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/instagram/instagram-original.svg" alt="Instagram" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∏</text></svg>'">
        <span>Instagram</span>
      </div>
      <div class="app-icon" onclick="shareToApp('snapchat')">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/snapchat/snapchat-original.svg" alt="Snapchat" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëª</text></svg>'">
        <span>Snapchat</span>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="popup-bg hidden confirm-modal" id="confirmPop">
  <div class="popup">
    <h3>Exit Room</h3>
    <p>Are you sure you want to leave?</p>
    <button class="confirm-btn" onclick="confirmExit()">Confirm</button>
    <button class="cancel-btn" onclick="closeConfirm()">Cancel</button>
  </div>
</div>

<!-- GAME -->
<div id="game" class="hidden">
  <div class="topbar">
    <button onclick="showConfirmExit()">‚ùå</button>
    <div class="center">
      üë§ <span id="statusDot" class="dot-offline"></span> <span id="statusText">Offline</span>
    </div>
    <button id="inviteBtn" onclick="openShare()">üîó</button>
  </div>

  <div class="body">
    <img src="teddy.png" alt="Teddy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß∏</text></svg>'">
    <h2>Scratch Adventure</h2>
    <p>Scratch the field with your finger</p>
    <p id="infoText">Waiting for partner...</p>

    <div class="nameplate" id="roomLabel"></div>

    <div class="dare-box">
      <canvas id="scratch"></canvas>
      <div id="dareText">‚ù§Ô∏è Scratch to reveal!</div>
    </div>

    <button id="doneBtn" class="hidden" onclick="done()">Dare Completed</button>
    <div class="creator-tag">Created by devherrryyy</div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* ===== PARTICLES ===== */
const p=document.getElementById("particles");
for(let i=0;i<25;i++){
  const d=document.createElement("div");
  d.className="particle "+(Math.random()>.5?"heart":"dot");
  d.style.left=Math.random()*100+"%";
  d.style.top=Math.random()*100+"%";
  p.appendChild(d);
}

/* ===== SOCKET SETUP ===== */
let socket;
let room="",role="",myTurn=false,scratched=false;
let reconnectAttempts=0;
let partnerOnline=false;
let creatorToken=null; // Token for creator auto-login

function connectSocket(){
  socket = io({
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 10,
    timeout: 20000
  });

  socket.on("connect", () => {
    console.log("‚úÖ Connected to server");
    reconnectAttempts=0;
    
    // Try to rejoin from localStorage
    const savedSession = localStorage.getItem('scratchAdventureSession');
    if(savedSession){
      const { room: savedRoom, role: savedRole, token } = JSON.parse(savedSession);
      if(savedRoom && savedRole){
        console.log("üîÑ Attempting to rejoin room:", savedRoom);
        socket.emit("rejoin-room", { room: savedRoom, role: savedRole, token });
      }
    }
  });

  socket.on("disconnect", reason => {
    console.log("‚ùå Disconnected:", reason);
    if(reason === "io server disconnect"){
      alert("Server disconnected. Refresh page.");
    }
  });

  socket.on("connect_error", err => {
    console.log("Connection error:", err);
    reconnectAttempts++;
    if(reconnectAttempts > 3){
      alert("Network issue. Check connection.");
    }
  });

  /* ===== ROOM EVENTS ===== */
  socket.on("room-created", d => {
    role=d.role; room=d.room; creatorToken=d.creatorToken||null;
    // Save session
    localStorage.setItem('scratchAdventureSession', JSON.stringify({ room, role, token: creatorToken }));
    startGame();
  });

  socket.on("room-joined", d => {
    role=d.role; room=d.room;
    // Save session
    localStorage.setItem('scratchAdventureSession', JSON.stringify({ room, role }));
    startGame();
  });

  socket.on("room-rejoined", d => {
    role=d.role; room=d.room; myTurn=d.myTurn;
    partnerOnline=d.partnerOnline;
    updateDotStatus(partnerOnline);
    startGame();
    console.log("‚úÖ Successfully rejoined room");
  });

  socket.on("room-error", data => {
    if(data.type==='create' || data.type==='join'){
      // Clear invalid session
      localStorage.removeItem('scratchAdventureSession');
    }
    if(data.type==='create'){
      showError('create',data.msg);
    } else if(data.type==='join'){
      showError('join',data.msg);
    } else if(data.type==='rejoin'){
      console.log("Rejoin failed:", data.msg);
      localStorage.removeItem('scratchAdventureSession');
    }
  });

  socket.on("joiner-joined", () => {
    infoText.textContent="Partner joined! Starting...";
    updateDotStatus(true);
    setTimeout(()=>{
      infoText.textContent=myTurn?"Your turn":"Partner's turn";
    },2000);
  });

  socket.on("joiner-left", () => {
    alert("Partner left the room!");
    updateDotStatus(false);
    setTimeout(()=>location.reload(), 2000);
  });

  socket.on("room-closed", () => {
    alert("Room closed by creator!");
    localStorage.removeItem('scratchAdventureSession');
    location.reload();
  });

  /* ===== PARTNER STATUS EVENTS ===== */
  socket.on("partner-status", ({ online }) => {
    updateDotStatus(online);
  });

  /* ===== GAMEPLAY EVENTS ===== */
  socket.on("reveal-dare", dare => {
    dareText.textContent=dare;
    doneBtn.classList.remove("hidden");
  });

  socket.on("next-turn", turn => {
    myTurn=(turn===role);
    scratched=false;
    doneBtn.classList.add("hidden");
    dareText.textContent="‚ù§Ô∏è Scratch to reveal!";
    setupCanvas();
    infoText.textContent=myTurn?"Your turn":"Partner's turn";
  });

  socket.on("scratch", data => {
    if(!myTurn && canvas.width>0){
      ctx.beginPath();
      ctx.arc(data.x*canvas.width, data.y*canvas.height, data.r*canvas.width, 0, Math.PI*2);
      ctx.fill();
    }
  });
}

/* ===== UPDATE DOT STATUS ===== */
function updateDotStatus(online){
  partnerOnline=online;
  const dot=document.getElementById('statusDot');
  const statusText=document.getElementById('statusText');
  
  if(online){
    dot.className='dot-online';
    statusText.textContent='Online';
    statusText.style.color='#4CAF50';
  } else {
    dot.className='dot-offline';
    statusText.textContent='Offline';
    statusText.style.color='#999';
  }
}

/* ===== POPUP HELPERS ===== */
function closeAllPopups(){
  createPop.classList.add("hidden");
  joinPop.classList.add("hidden");
  sharePop.classList.add("hidden");
  confirmPop.classList.add("hidden");
  document.querySelectorAll('.error-msg').forEach(el=>{el.style.display='none'; el.textContent='';});
  document.getElementById('copySuccess').style.display='none';
}
function showError(type,msg){
  const errEl=document.getElementById(type+'Error');
  errEl.textContent=msg;
  errEl.style.display='block';
}

/* ===== WELCOME ===== */
const openCreate=()=>{
  createPop.classList.remove("hidden");
  joinPop.classList.add("hidden");
}
const openJoin=()=>{
  joinPop.classList.remove("hidden");
  createPop.classList.add("hidden");
}

/* ===== ROOM ACTIONS ===== */
function createRoom(){
  const name=cName.value.trim();
  const pass=cPass.value.trim();
  if(!name||!pass){
    showError('create','Please fill all fields');
    return;
  }
  if(name.length<3){
    showError('create','Room name min 3 characters');
    return;
  }
  socket.emit("create-room",{name,password:pass});
}
function joinRoom(){
  const name=jName.value.trim();
  const pass=jPass.value.trim();
  if(!name||!pass){
    showError('join','Please fill all fields');
    return;
  }
  socket.emit("join-room",{name,password:pass});
}

/* ===== SHARE MODAL ===== */
function openShare(){
  if(!room) return;
  const link=`${window.location.origin}/?room=${room}`;
  document.getElementById('shareLink').textContent=link;
  sharePop.classList.remove('hidden');
}
function closeShare(){
  sharePop.classList.add('hidden');
}
function copyLink(){
  const link=document.getElementById('shareLink').textContent;
  navigator.clipboard.writeText(link).then(()=>{
    document.getElementById('copySuccess').style.display='block';
    setTimeout(()=>{
      closeShare();
      document.getElementById('copySuccess').style.display='none';
    },1500);
  }).catch(()=>{
    alert('Copy failed. Please copy manually.');
  });
}
function shareToApp(app){
  if(!room) return;
  const link=`${window.location.origin}/?room=${room}`;
  const text=`Join my Scratch Adventure room: ${room}`;
  let url='';
  switch(app){
    case 'whatsapp':
      url=`https://wa.me/?text=${encodeURIComponent(text+' '+link)}`;
      break;
    case 'instagram':
      alert('‚ö†Ô∏è Instagram: Copy link and paste in chat');
      return;
    case 'snapchat':
      url=`https://snapchat.com/scan?attachmentUrl=${encodeURIComponent(link)}`;
      break;
  }
  if(url) window.open(url,'_blank');
  closeShare();
}

/* ===== CONFIRM EXIT ===== */
function showConfirmExit(){
  confirmPop.classList.remove('hidden');
}
function closeConfirm(){
  confirmPop.classList.add('hidden');
}
function confirmExit(){
  if(role==="creator") socket.emit("exit-room",room);
  // Clear session on explicit exit
  localStorage.removeItem('scratchAdventureSession');
  socket.disconnect();
  location.reload();
}

/* ===== GAME START ===== */
function startGame(){
  closeAllPopups();
  welcome.classList.add("hidden");
  game.classList.remove("hidden");
  roomLabel.textContent=room;
  if(role==="joiner") inviteBtn.style.display="none";
  
  setupCanvas();
  
  if(role==="creator"){
    myTurn=true;
    infoText.textContent="Your turn";
    if(!partnerOnline) updateDotStatus(false);
  } else {
    myTurn=false;
    infoText.textContent="Partner's turn";
    updateDotStatus(true);
  }
}

/* ===== CANVAS SETUP & SCRATCHING ===== */
const canvas=document.getElementById("scratch");
const ctx=canvas.getContext("2d");
let drawing=false;

function setupCanvas(){
  const box=document.querySelector('.dare-box');
  const rect=box.getBoundingClientRect();
  
  // Handle high DPI screens
  const dpr=window.devicePixelRatio||1;
  canvas.width=rect.width*dpr;
  canvas.height=rect.height*dpr;
  canvas.style.width=rect.width+'px';
  canvas.style.height=rect.height+'px';
  ctx.scale(dpr,dpr);
  
  // Fill with red overlay
  ctx.fillStyle="#ff416c";
  ctx.fillRect(0,0,rect.width,rect.height);
  ctx.globalCompositeOperation="destination-out";
}

function getPos(e){
  const rect=canvas.getBoundingClientRect();
  return {
    x:(e.clientX-rect.left)/rect.width,
    y:(e.clientY-rect.top)/rect.height
  };
}

canvas.onpointerdown=e=>{
  if(!myTurn||scratched) return;
  drawing=true;
  e.preventDefault();
};
canvas.onpointermove=e=>{
  if(!drawing||!myTurn||scratched) return;
  const pos=getPos(e);
  ctx.beginPath();
  ctx.arc(pos.x*canvas.width, pos.y*canvas.height, 18, 0, Math.PI*2);
  ctx.fill();
  socket.emit("scratch",{room,x:pos.x,y:pos.y,r:18/canvas.width});
  e.preventDefault();
};
canvas.onpointerup=()=>{
  if(drawing&&myTurn&&!scratched){
    drawing=false;
    scratched=true;
    socket.emit("scratch-complete",room);
  }
};
canvas.onpointerleave=()=>{drawing=false};

/* ===== GAME ACTIONS ===== */
function done(){
  socket.emit("done",room);
  doneBtn.classList.add("hidden");
}

/* ===== VISIBILITY & RESIZE HANDLING ===== */
document.addEventListener('visibilitychange',()=>{
  if(!document.hidden && socket && !socket.connected){
    reconnectAttempts=0;
    socket.connect();
  }
});

window.addEventListener('resize',()=>{
  if(!game.classList.contains('hidden')){
    setupCanvas();
  }
});

/* ===== BACKDROP CLICK CLOSE ===== */
document.querySelectorAll('.popup-bg').forEach(bg=>{
  bg.addEventListener('click',e=>{
    if(e.target===bg) closeAllPopups();
  });
});

/* ===== INIT ===== */
window.addEventListener('load',()=>{
  connectSocket();
  
  // Auto-fill room from URL for joiners
  const params=new URLSearchParams(window.location.search);
  const roomParam=params.get('room');
  if(roomParam){
    openJoin();
    jName.value=roomParam;
  }
});

/* ===== ERROR HANDLING ===== */
window.addEventListener('error',e=>{
  console.error('Client error:',e.error);
});
window.addEventListener('unhandledrejection',e=>{
  console.error('Unhandled promise rejection:',e.reason);
});
</script>
</body>
</html>
