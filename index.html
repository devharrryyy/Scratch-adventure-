 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Scratch Adventure üíï</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;overflow:hidden}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 50%,#fecfef 100%);
      color:#fff;touch-action:none;position:fixed;width:100%;height:100%
    }

    /* ===== FLOATING PARTICLES ===== */
    .particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0}
    .particle{
      position:absolute;border-radius:50%;
      animation:float 6s infinite ease-in-out;
      opacity:0;
    }
    .particle.heart{width:14px;height:14px;background:#ff6b6b}
    .particle.dot1{width:10px;height:10px;background:#ffd93d}
    .particle.dot2{width:12px;height:12px;background:#4CAF50}
    .particle.dot3{width:8px;height:8px;background:#2196F3}
    .particle.dot4{width:11px;height:11px;background:#9C27B0}
    @keyframes float{
      0%{transform:translateY(100vh) translateX(0) scale(1);opacity:0}
      10%{opacity:.8}
      90%{opacity:.8}
      100%{transform:translateY(-20px) translateX(var(--drift)) scale(.6);opacity:0}
    }

    /* ===== POPUPS ===== */
    .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
    .popup{background:#fff;padding:30px;border-radius:20px;text-align:center;max-width:90%;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .popup h3{margin-bottom:15px;color:#333;font-size:1.5em}
    .popup input{padding:12px;border:2px solid #ff6b6b;border-radius:25px;width:100%;margin:15px 0;font-size:1em}
    .popup button{padding:12px 30px;margin:5px;border:none;border-radius:20px;cursor:pointer;font-weight:bold;font-size:1em}
    .popup button:first-of-type{background:#4CAF50;color:#fff}
    .popup button:last-of-type{background:#ff6b6b;color:#fff}

    /* ===== WELCOME SCREEN + ANIMATIONS ===== */
    .welcome-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;position:relative;z-index:1}
    /* title */
    .main-title{
      font-size:4em;margin-bottom:30px;
      background:linear-gradient(45deg,#ff6b6b,#ffd93d);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:glow 2s ease-in-out infinite alternate, titlePulse 2.5s ease-in-out infinite;
    }
    @keyframes glow{from{filter:drop-shadow(0 0 10px rgba(255,107,107,.5))}to{filter:drop-shadow(0 0 20px rgba(255,217,61,.8))}}
    @keyframes titlePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    /* button */
    .create-btn{
      padding:18px 50px;font-size:1.2em;
      background:linear-gradient(45deg,#ff6b6b,#ff8787);
      border:none;border-radius:50px;color:#fff;cursor:pointer;font-weight:bold;
      box-shadow:0 10px 30px rgba(255,107,107,.4);
      animation:btnFloat 3s ease-in-out infinite;
      transition:all .3s;
    }
    @keyframes btnFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .create-btn:hover{transform:translateY(-5px) scale(1.05);box-shadow:0 15px 40px rgba(255,107,107,.6)}

    /* ===== GAME SCREEN ===== */
    .game-screen{display:none;flex-direction:column;height:100vh;position:relative;z-index:1}
    .top-bar{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:rgba(0,0,0,.1);backdrop-filter:blur(10px);position:fixed;top:0;left:0;right:0;z-index:100}
    .top-btn{width:45px;height:45px;border:none;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;font-size:18px;cursor:pointer;backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;transition:all .3s}
    .top-btn:active{transform:scale(.9)}
    .center-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;padding-top:80px;padding-bottom:80px}
    .game-title{font-size:2.5em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.2);color:#000;text-align:center;line-height:1.2}
    .instruction{font-size:1.2em;margin-bottom:15px;color:#333;font-weight:500;text-align:center}
    .turn-indicator{margin:10px 0;font-size:1.3em;font-weight:bold;animation:pulse 1.5s infinite;color:#333;text-align:center;line-height:1.3;min-height:30px}
    @keyframes pulse{0%,100%{opacity:.7}50%{opacity:1}}
    .name-plate{background:linear-gradient(45deg,gold,#ffd700);padding:10px 25px;border-radius:25px;font-size:15px;color:#333;font-weight:bold;box-shadow:0 5px 15px rgba(0,0,0,.2);margin:10px 0;text-align:center}
    .dare-box{position:relative;width:350px;height:120px;margin:20px 0;border-radius:15px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,.2)}
    #scratchCanvas{position:absolute;top:0;left:0;width:100%;height:100%;background:#ff0000;cursor:crosshair;border-radius:15px;z-index:2}
    #dareText{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;text-align:center;color:#333;font-weight:bold;font-size:17px;padding:15px;background:#fff;border-radius:15px;z-index:1;line-height:1.4;word-wrap:break-word}
    .complete-btn{padding:15px 40px;font-size:1.1em;background:linear-gradient(45deg,#4CAF50,#66BB6A);border:none;border-radius:30px;color:#fff;cursor:pointer;font-weight:bold;margin:20px 0;transition:all .3s;text-align:center}
    .complete-btn:hover{transform:scale(1.05);box-shadow:0 8px 25px rgba(76,175,80,.4)}
    .complete-btn:disabled{background:#ccc!important;cursor:not-allowed!important;transform:scale(1)!important;opacity:.6}
    .bottom-bar{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:rgba(0,0,0,.1);backdrop-filter:blur(10px);position:fixed;bottom:0;left:0;right:0;z-index:100}
    .profile-status{display:flex;align-items:center;gap:10px;font-size:14px;color:#333;font-weight:500}
    .profile-icon{width:35px;height:35px;border-radius:50%;background:#ff6b6b;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff}
    .creator-info{color:#333;font-size:.9em;text-align:center}
    .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:5px;box-shadow:0 0 5px rgba(0,0,0,.2)}
    .status-online{background:#4CAF50;animation:blink 1.5s infinite}
    .status-offline{background:#ccc}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
    .hidden{display:none!important}
    @media (max-width:600px){
      .dare-box{width:90%;max-width:350px}
      .game-title{font-size:2em}
      .instruction{font-size:1em}
      .turn-indicator{font-size:1.1em}
    }
  </style>
</head>
<body>
  <!-- ===== FLOATING PARTICLES ===== -->
  <div class="particles" id="particles"></div>

  <!-- ===== POPUPS ===== -->
  <div class="popup-overlay" id="exitConfirm"><div class="popup"><h3>‚ùå Exit Game?</h3><p>Are you sure you want to leave?</p><button onclick="exitGame()">Confirm</button><button onclick="closeExitPopup()">Cancel</button></div></div>
  <div class="popup-overlay" id="roomPopup"><div class="popup"><h3>üéÆ Create Room</h3><input type="text" id="roomNameInput" placeholder="Enter your name..." maxlength="20"><button onclick="createRoom()">Create Room</button><button onclick="closeRoomPopup()">Cancel</button></div></div>
  <div class="popup-overlay" id="invitePopup"><div class="popup"><h3>üîó Invite Friend</h3><input type="text" id="inviteLink" readonly><button onclick="copyLink()">Copy Link</button><button onclick="closeInvitePopup()">Close</button></div></div>

  <!-- ===== WELCOME SCREEN ===== -->
  <div class="welcome-screen" id="welcomeScreen">
    <h1 class="main-title">üíï Scratch Adventure üíï</h1>
    <button class="create-btn" onclick="showRoomPopup()">Create Room</button>
  </div>

  <!-- ===== GAME SCREEN ===== -->
  <div class="game-screen" id="gameScreen">
    <div class="top-bar">
      <button class="top-btn exit-btn" onclick="showExitConfirm()">‚ùå</button>
      <button class="top-btn invite-btn" id="inviteBtn" onclick="showInvitePopup()">üîó</button>
    </div>
    <div class="center-content">
      <h2 class="game-title">üíï Scratch Adventure</h2>
      <p class="instruction">Scratch the field with your finger</p>
      <div class="turn-indicator" id="turnIndicator">Waiting for partner to join...</div>
      <div class="name-plate" id="creatorName">Room</div>
      <div class="dare-box" id="dareBox">
        <canvas id="scratchCanvas"></canvas>
        <div id="dareText">‚ô•Ô∏è Scratch to reveal!</div>
      </div>
      <button class="complete-btn hidden" id="completeBtn" onclick="completeDare()">‚úÖ Dare Completed</button>
    </div>
    <div class="bottom-bar">
      <div class="profile-status"><div class="profile-icon">üë§</div><span id="joinerStatus">Partner <span class="status-dot status-offline"></span></span></div>
      <div class="creator-info">Created by urluv_harrryyy</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== CONFIG =====
    const CONFIG = {
      SCRATCH_THRESHOLD: 0.6,
      CANVAS_WIDTH: 350,
      CANVAS_HEIGHT: 120,
      SCRATCH_RADIUS: 25,
      PIXEL_SAMPLE_RATE: 40,
      ACTIVE_CHECK_INTERVAL: 2000
    };
    const socket = io();
    let currentRole = '', currentRoom = '', creatorName = '', hasScratched = false, isMyTurn = false, joinerJoined = false, isPageActive = true, lastScratchX = 0, lastScratchY = 0;

    // ===== FLOATING PARTICLES =====
    function createParticles(){
      const container = document.getElementById('particles');
      const colors = ['heart','dot1','dot2','dot3','dot4'];
      for (let i = 0; i < 25; i++){
        const p = document.createElement('div');
        const type = colors[Math.floor(Math.random()*colors.length)];
        p.className = 'particle '+type;
        p.style.left = Math.random()*100 + '%';
        p.style.setProperty('--drift', (Math.random()*60 - 30) + 'px');
        p.style.animationDelay = Math.random()*6 + 's';
        p.style.animationDuration = (6 + Math.random()*4) + 's';
        container.appendChild(p);
      }
    }
    createParticles();

    // ===== POPUP HELPERS =====
    function showRoomPopup(){document.getElementById('roomPopup').style.display='flex'}
    function closeRoomPopup(){document.getElementById('roomPopup').style.display='none'}
    function showInvitePopup(){
      const base = window.location.origin + window.location.pathname.replace(/\/$/,'');
      document.getElementById('inviteLink').value = `${base}?room=${encodeURIComponent(currentRoom)}`;
      document.getElementById('invitePopup').style.display='flex';
    }
    function closeInvitePopup(){document.getElementById('invitePopup').style.display='none'}
    function showExitConfirm(){document.getElementById('exitConfirm').style.display='flex'}
    function closeExitPopup(){document.getElementById('exitConfirm').style.display='none'}

    // ===== ROOM =====
    function createRoom(){
      const name = document.getElementById('roomNameInput').value.trim().replace(/[<>\"']/g,'').substring(0,20);
      if(name){ currentRoom = name; creatorName = name; currentRole = 'creator';
        document.getElementById('creatorName').textContent = creatorName;
        document.getElementById('inviteBtn').style.display = 'block';
        closeRoomPopup(); joinGame();
      }
    }
    function joinGame(){
      document.getElementById('welcomeScreen').classList.add('hidden');
      document.getElementById('gameScreen').style.display='flex';
      setupCanvas();
      socket.emit('join',currentRoom);
      setInterval(()=>{ if(currentRoom && socket.connected) socket.emit('user-active',{room:currentRoom,active:isPageActive}) },CONFIG.ACTIVE_CHECK_INTERVAL);
    }
    async function copyLink(){
      const link = document.getElementById('inviteLink');
      try{ await navigator.clipboard.writeText(link.value) }catch{ link.select(); document.execCommand('copy') }
      alert('üìã Link copied!'); closeInvitePopup();
    }

    // ===== CANVAS =====
    const canvas = document.getElementById('scratchCanvas');
    const ctx = canvas.getContext('2d');
    function setupCanvas(){
      const dpr = window.devicePixelRatio||1;
      canvas.width = CONFIG.CANVAS_WIDTH*dpr; canvas.height = CONFIG.CANVAS_HEIGHT*dpr;
      canvas.style.width = CONFIG.CANVAS_WIDTH+'px'; canvas.style.height = CONFIG.CANVAS_HEIGHT+'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = '#ff0000'; ctx.fillRect(0,0,CONFIG.CANVAS_WIDTH,CONFIG.CANVAS_HEIGHT);
      ctx.globalCompositeOperation = 'destination-out';
    }

    // ===== SOCKET =====
    socket.on('role',role=>{ currentRole=role; isMyTurn=(role==='creator'); if(role==='joiner')document.getElementById('inviteBtn').style.display='none'; updateUI(); });
    socket.on('state',state=>{ joinerJoined=state.joinerJoined; hasScratched=state.scratched; document.getElementById('dareText').textContent = state.scratched?state.dare:'‚ô•Ô∏è Scratch to reveal!'; if(!state.scratched){setupCanvas();document.getElementById('completeBtn').classList.add('hidden')}else{document.getElementById('completeBtn').classList.remove('hidden')} updateUI(); });
    socket.on('joiner-joined',()=>{joinerJoined=true;updateUI()});
    socket.on('joiner-left',()=>{joinerJoined=false;updateUI()});
    socket.on('user-active-status',data=>{ const dot=document.querySelector('#joinerStatus .status-dot'); dot.className=data.active?'status-dot status-online':'status-dot status-offline' });
    socket.on('new-turn',data=>{ hasScratched=false; document.getElementById('dareText').textContent='‚ô•Ô∏è Scratch to reveal!'; document.getElementById('completeBtn').classList.add('hidden'); setupCanvas(); isMyTurn=(currentRole===data.turn); updateUI(); });
    socket.on('reveal',dare=>{ document.getElementById('dareText').textContent=dare; document.getElementById('completeBtn').classList.remove('hidden'); hasScratched=true; updateUI(); });
    socket.on('room-closed',()=>{ alert('üö´ Room closed by creator. Redirecting...'); window.location.href=window.location.pathname });
    socket.on('error',msg=>{ alert(`‚ùå ${msg}`); if(msg.includes('closed'))window.location.href=window.location.pathname });

    // ===== UI =====
    function updateUI(){
      const ind=document.getElementById('turnIndicator'),dot=document.querySelector('#joinerStatus .status-dot'),btn=document.getElementById('completeBtn');
      dot.className=joinerJoined?'status-dot status-online':'status-dot status-offline';
      if(!joinerJoined)ind.textContent='‚è≥ Waiting for partner to join...';
      else if(isMyTurn&&!hasScratched)ind.textContent='‚ú® Your turn! Scratch to reveal';
      else if(!isMyTurn&&!hasScratched)ind.textContent='‚è≥ Waiting for partner to scratch...';
      else if(hasScratched)ind.textContent='üíñ Dare revealed! Tap "Dare Completed"';
      if(hasScratched&&joinerJoined)btn.classList.remove('hidden'); else btn.classList.add('hidden');
    }
    function completeDare(){ if(!hasScratched||!joinerJoined)return; socket.emit('done',currentRoom); document.getElementById('completeBtn').classList.add('hidden'); hasScratched=false; setupCanvas(); updateUI(); }

    // ===== SCRATCH =====
    let isDrawing=false;
    function getXY(e){
      const rect=canvas.getBoundingClientRect();
      return {
        x:(e.clientX-rect.left)*(CONFIG.CANVAS_WIDTH/rect.width),
        y:(e.clientY-rect.top)*(CONFIG.CANVAS_HEIGHT/rect.height)
      }
    }
    canvas.addEventListener('mousedown',e=>{ if(isMyTurn&&joinerJoined&&!hasScratched){isDrawing=true;const pt=getXY(e);lastScratchX=pt.x;lastScratchY=pt.y}});
    canvas.addEventListener('mousemove',e=>{
      if(!isDrawing||!isMyTurn||!joinerJoined||hasScratched)return;
      const pt=getXY(e);
      ctx.lineWidth=CONFIG.SCRATCH_RADIUS*2; ctx.lineCap='round';
      ctx.beginPath(); ctx.moveTo(lastScratchX,lastScratchY); ctx.lineTo(pt.x,pt.y); ctx.stroke();
      lastScratchX=pt.x; lastScratchY=pt.y;
      socket.emit('scratch',{room:currentRoom,x:pt.x,y:pt.y,radius:CONFIG.SCRATCH_RADIUS});
    });
    canvas.addEventListener('mouseup',()=>{if(isMyTurn){isDrawing=false;checkScratchComplete()}});
    canvas.addEventListener('mouseleave',()=>isDrawing=false);
    canvas.addEventListener('touchstart',e=>{e.preventDefault();if(isMyTurn&&joinerJoined&&!hasScratched){isDrawing=true;const pt=getXY(e.touches[0]);lastScratchX=pt.x;lastScratchY=pt.y}});
    canvas.addEventListener('touchmove',e=>{e.preventDefault();if(!isDrawing||!isMyTurn||!joinerJoined||hasScratched)return;const pt=getXY(e.touches[0]);ctx.lineWidth=CONFIG.SCRATCH_RADIUS*2;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(lastScratchX,lastScratchY);ctx.lineTo(pt.x,pt.y);ctx.stroke();lastScratchX=pt.x;lastScratchY=pt.y;socket.emit('scratch',{room:currentRoom,x:pt.x,y:pt.y,radius:CONFIG.SCRATCH_RADIUS})});
    canvas.addEventListener('touchend',()=>{if(isMyTurn){isDrawing=false;checkScratchComplete()}});
    socket.on('scratch',data=>{ctx.lineWidth=CONFIG.SCRATCH_RADIUS*2;ctx.lineCap='round';ctx.beginPath();ctx.arc(data.x,data.y,data.radius,0,Math.PI*2);ctx.fill()});
    function checkScratchComplete(){
      try{
        const img=ctx.getImageData(0,0,CONFIG.CANVAS_WIDTH,CONFIG.CANVAS_HEIGHT),data=img.data; let t=0;
        for(let i=3;i<data.length;i+=CONFIG.PIXEL_SAMPLE_RATE)if(data[i]<128)t++;
        if(t>(data.length/CONFIG.PIXEL_SAMPLE_RATE)*CONFIG.SCRATCH_THRESHOLD&&isMyTurn)socket.emit('scratch-complete',currentRoom);
      }catch(e){console.error(e)}
    }

    // ===== EXIT =====
    function exitGame(){ if(socket)socket.disconnect(); window.location.href=window.location.pathname }
    document.addEventListener('visibilitychange',()=>isPageActive=!document.hidden);

    // ===== AUTO-JOIN =====
    const urlParams=new URLSearchParams(window.location.search),roomParam=urlParams.get('room');
    if(roomParam){
      socket.emit('check-room',roomParam);
      socket.on('room-check-result',exists=>{
        if(exists){ currentRoom=roomParam; creatorName=roomParam; currentRole='joiner'; document.getElementById('creatorName').textContent=creatorName; document.getElementById('inviteBtn').style.display='none'; setTimeout(()=>joinGame(),100) }
        else{ alert('üö´ This invite link is no longer valid! Room closed by creator.'); window.location.href=window.location.pathname }
      });
    }
  </script>
</body>
</html>
